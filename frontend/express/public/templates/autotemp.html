                  

<table id="user-table" cellspacing="0" class="d-table">
	<thead>
		<tr>
			<th data-localize="management-applications.template.ID"></th>
			<th data-localize="management-applications.template.name"></th>			
			<th data-localize=" "></th>
			<th data-localize=" "></th>			
		</tr>
	</thead>
	<tbody>
		{{#eachOfObjectValue temp_items}}
		<tr>
			<td class="user-full-name">{{this.id}}</td>
			<td class="user-username">{{this.name}}</td>
			<td class="user-full-name"></td>
			<td class="user-username">
				<div>
					<span class="user-email">操作</span>
					<div class="help-edit" data-localize="management-users.edit"></div>
					<div class="help-close" data-localize="management-users.close"></div>
				</div>				
			</td>			
		</tr>
	    

		<tr class="user-details">			
			<td colspan="4">
				<div>

					{{#with this.params}}					
					<div class="row help-zone-vs " style="background:white" data-help-localize="sidebar.devicemgr.hotspot.config">
			

						<div class="title" data-localize="sidebar.devicemgr.mode"></div>					
						<div class="detail">
		          					
                        <div class="cly-select" style="width:220px;">
		          	    <div class="select-inner">
		          	    	<div class="text-container">
		          	    		<div class="text" id="channel-add-category" data-localize="manaapplications.category.tip" data={{this.wifimode}}>{{wifimode_text this.wifimode}}</div>
		          	    	</div>
		          	    	<div class="right combo"></div>
		          	    </div>
		          	    <div class="select-items square" style="width:220px;">
		          	    	<div class="scrollable">
		          	    		{{> mode-categories }}
		          	    	</div>
		          	    </div>
                        </div>   	          
						</div>						
					</div>	

					<div class="row help-zone-vs " style="background:white" data-help-localize="sidebar.devicemgr.hotspot.config">

						<div class="title" data-localize="sidebar.devicemgr.channel"></div>
						    <div class="detail">

                            <div class="cly-select" style="width:220px;">
		          	        <div class="select-inner">
		          	        	<div class="text-container">
		          	        		<div class="text" id="mode-add-category" data-localize="manaapplications.category.tip" data={{this.channel}}>{{channel_text this.channel}}</div>
		          	        	</div>
		          	        	<div class="right combo"></div>
		          	        </div>
		          	        <div class="select-items square" style="width:220px;">
		          	        	<div class="scrollable">
		          	        		{{> channel-categories }}
		          	        	</div>
		          	        </div>
                            </div> 

						</div>
					</div>			

					<div class="row help-zone-vs " style="background:white" data-help-localize="sidebar.devicemgr.hotspot.config">
						<div class="title" data-localize="sidebar.devicemgr.SSID"></div>
						<div class="detail">

           				<input class="username-text" id="hotspot-name-input" style="position:relative;margin-top:5px;margin-bottom:5px; width:100%;" type="text" value="{{this.ssid}}"/><br/>
						</div>
					</div>		
						    
					{{/with }}
					
					{{#eachOfObjectValue this.templates}}
						 {{#with this}}   
					<div class="row help-zone-vs " style="" data-help-localize="manage-users.full-name">
						<div class="title" data-localize="management-applications.filter"></div>
						<div> {{this.id}}</div>
						<div class="detail">						
                            <div class="cly-select" style="width:220px;">
			                   <div class="select-inner">
			                   	  <div class="text-container">
			                   	  	<div class="text" id="channel-add-category" data-localize="manaapplications.  category.tip">{{this.condition_temp}}
			                   	  	</div>
			                   	  </div>
			                   	  <div class="right combo">			                   		
			                   	  </div>
			                   </div>
			                   <div class="select-items square" style="width:220px;">
			                    	<div class="scrollable">
			                    		{{> template-condition-box }}
			                    	</div>
			                   </div>
                            </div>   	   

                            <div class="cly-select" style="width:120px;">
			                    <div class="select-inner">
			                    	    <div class="text-container">
			                    	    	<div class="text" id="channel-add-category" data-localize="manaapplications. category.tip">{{this.judgement}}
			                    	    	</div>
			                    	    </div>
			                    	<div class="right combo">			                   		
			                    	</div>
			                    </div>
			                    <div class="select-items square" style="width:120px;">
			                    	  <div class="scrollable">
			                    	  	{{> template-compare-box }}
			                    	  </div>
			                    </div>
                            </div>   	     

						     <input class="email-text" type="text" value="{{this.input}}"/ style="position:relative;top:-7px;">
														
					      	<div class="select-temps" style="position:relative;top:4px;">
					      	    <input type="hidden" value="" class="app-list"/>
					      	</div>
						</div>
					      			
					</div>					
					{{/with}}
					<div class="button-container">
						<a class="icon-button light save-user" data-localize="common.save"></a>
						<a class="icon-button light cancel-user" data-localize="common.cancel"></a>
						<a class="icon-button red delete-user" data-localize="management-applications.template.delete"></a>
					</div>

				{{/eachOfObjectValue}}	
				</div>
			</td>
		</tr>
		{{/eachOfObjectValue}}

		<tr>
			<td colspan="4">
				<div data-localize="management-applications.create-temp"></div>			
			</td>
		</tr>
		<tr class="user-details">
			<td colspan="4">
				<div id = "temp_container">	

	
					<div class="row help-zone-vs " style="background:white;" data-help-localize="sidebar.devicemgr.hotspot.config">
						<div class="title" data-localize="sidebar.devicemgr.mode"></div>
						<div class="detail">
		          					
                        <div class="cly-select" style="width:220px;">
		          	    <div class="select-inner">
		          	    	<div class="text-container">
		          	    		<div class="text text_mode" id="channel-params-category" data-localize="manaapplications.category.tip"></div>
		          	    	</div>
		          	    	<div class="right combo"></div>
		          	    </div>
		          	    <div class="select-items square" style="width:220px;">
		          	    	<div class="scrollable">
		          	    		{{> mode-categories }}
		          	    	</div>
		          	    </div>
                        </div>   	          

						</div>						
					</div>	

					<div class="row help-zone-vs " style="background:white;" data-help-localize="sidebar.devicemgr.hotspot.config">
						<div class="title" data-localize="sidebar.devicemgr.channel"></div>
						<div class="detail">

                        <div class="cly-select" style="width:220px;">
		          	    <div class="select-inner">
		          	    	<div class="text-container">
		          	    		<div class="text text_channel" id="mode-params-category" data-localize="manaapplications.category.tip"></div>
		          	    	</div>
		          	    	<div class="right combo"></div>
		          	    </div>
		          	    <div class="select-items square" style="width:220px;">
		          	    	<div class="scrollable">
		          	    		{{> channel-categories }}
		          	    	</div>
		          	    </div>
                        </div> 

						</div>
					</div>			

					<div class="row help-zone-vs " style="background:white;" data-help-localize="sidebar.devicemgr.hotspot.config">
						<div class="title" data-localize="sidebar.devicemgr.SSID"></div>
						<div class="detail">

           				<input class="username-text" id="ssid-params-input" style="position:relative;margin-top:5px;margin-bottom:5px; width:100%;" type="text" value=""/><br/>
						</div>
					</div>		
				    	
					<div  id="filter_container" class="row help-zone-vs " style="" data-help-localize="manage-users.full-name">

					</div>
					<div  class="row help-zone-vs ">
				        	<div class="button-container">
				        		<input class="user_id" type="hidden" value="{{this._id}}"/>
				        		<a class="icon-button light save-template" data-localize="common.save"></a>
				        		<a class="icon-button light cancel-template" data-localize="common.cancel"></a>				        					        		
				        	</div>	
					</div>
					<div id="new-temp-bar" class="row help-zone-vs " data-help-localize="manage-users.full-name" style="display:none">
						<div class="title" data-localize="management-applications.filter"></div>
						<div class="detail">							

                            <div class="cly-select cly-select-auto" style="width:220px;">
			                   <div class="select-inner">
			                   	<div class="text-container">
			                   		<div class="text text_condition" id="channel-add-category" data-localize="manaapplications.category.tip"></div>
			                   	</div>
			                   	<div class="right combo"></div>
			                   </div>
			                   <div class="select-items square select-items-auto" style="width:220px;">
			                   	<div class="scrollable">
			                   		{{> mode-categories }}
			                   	</div>
			                   </div>
                             </div>   	   

                            <div class="cly-select cly-select-auto" style="width:120px;">
			                   <div class="select-inner">
			                   	<div class="text-container">
			                   		<div class="text text_judgement" id="channel-add-category" data-localize="manaapplications.category.tip"></div>
			                   	</div>
			                   	<div class="right combo"></div>
			                   </div>
			                   <div class="select-items square select-items-auto" style="width:120px;">
			                   	<div class="scrollable">
			                   		{{> template-compare-box }}
			                   	</div>
			                   </div>
                             </div>   	     

						     <input class="condition-text" type="text" value=""/ style="position:relative;top:-7px;">
		
					      	<div class="select-temps-add" style="position:relative;top:4px;">
					      	    <input type="hidden" value="" class="app-list"/>
					      	</div>

				        </div>				      	
					</div>
				</div>
			</td>
		</tr>
	</tbody>
</table>


<div id="listof-apps">
	<div class="tip"></div>
	<div class="scrollable">
		{{#eachOfObjectValue apps}}
		<div class="app">
			<div class="image" style="background-image: url('/appimages/{{this._id}}.png');">
				<span class="name">{{this.name}}</span>
			</div>
			<input class="app_id" type="hidden" value="{{this._id}}"/>
		</div>
		{{/eachOfObjectValue}}
	</div>
	<div class="button-container">
		<a class="icon-button dark" id="done" data-localize="common.done"></a>
		<a class="icon-button dark" id="select-all" style="width:50px;" data-localize="common.select-all"></a>
		<a class="icon-button dark" id="deselect-all" data-localize="common.deselect-all"></a>
	</div>
</div>



<script>

$(document).ready(function() {
	var adminsOf = [],
		activeRow,
		userDetailsClone,
		previousUserDetails,
		lastUserSaved = false,
		previousSelectAppPos = {},
		currUsername = "",
		new_temp_bar = null,
		new_temp_data = [],
		new_params = {},
		user_templates = {},
		currEmail = "";

	
	//var template = Handlebars.compile($("#auto-template-export").html());
	//Handlebars.registerPartial("template-condition-box", $("#template-condition-categories").html());
	//$("#conf_content").html(template());
	//template(test_user:"this is test user");
	//$(this.el).html(template({
    //        test_user:"this is test user!"
    //    }));

	// translate help module
	$("[data-help-localize]").each(function() {
		var elem = $(this);
		if (elem.data("help-localize") != undefined) {
			elem.data("help", countlyCommon.HELP_MAP[elem.data("help-localize")]);
		}
	});
	
	// translate dashboard
	$("[data-localize]").each(function() {
		var elem = $(this);
		elem.text(jQuery.i18n.map[elem.data("localize")]);				
	});
	
	if ($("#help-toggle").hasClass("active")) {
		$('.help-zone-vb').tipsy({gravity: $.fn.tipsy.autoNS, trigger: 'manual', title: function(){ return ($(this).data("help"))? $(this).data("help") : ""; }, fade: true, offset: 5, cssClass: 'yellow', opacity: 1, html: true});
		$('.help-zone-vs').tipsy({gravity: $.fn.tipsy.autoNS, trigger: 'manual', title: function(){ return ($(this).data("help"))? $(this).data("help") : ""; }, fade: true, offset: 5, cssClass: 'yellow narrow', opacity: 1, html: true});
		
		

		$.idleTimer('destroy');
		clearInterval(self.refreshActiveView);
		$(".help-zone-vs, .help-zone-vb").hover(
			function () {
				$(this).tipsy("show");
			}, 
			function () {
				$(this).tipsy("hide");
			}
		);
	}

    function initializeSelect() {

    	$(".cly-select").unbind('click');
    	$(".select-items .item").unbind('click');

        $(".cly-select").click(function (e) {
            var selectItems = $(this).find(".select-items");
         
            if (!selectItems.length) {
                return false;
            }

            if (selectItems.is(":visible")) {
                $(this).removeClass("active");
            } else {
                $(".cly-select").removeClass("active");
                $(".select-items").hide();
                $(this).addClass("active");
            }

            $(this).find(".select-items").toggle();

            $("#date-picker").hide();
            e.stopPropagation();
        });

        $(".select-items .item").click(function () {
            var selectedItem = $(this).parents(".cly-select").find(".text");
            selectedItem.text($(this).text());
            selectedItem.data("value", $(this).data("value"));
        });
    }

	function closeActiveEditAuto() {
		if (previousUserDetails) {
			previousUserDetails.replaceWith(userDetailsClone);
			previousUserDetails = null;
		}
		
		$(".user-details").hide();
		$("#user-table").find("tbody tr.active").removeClass("active");
		$("#user-table").find("tbody tr:not(.user-details)").css({"opacity": "1"});
		$("#listof-apps").hide();
	}

	function closeActiveEdit() {
		if (previousUserDetails) {
			previousUserDetails.replaceWith(userDetailsClone);
			previousUserDetails = null;
		}
		
		$(".user-details").hide();
		$("#user-table").find("tbody tr.active").removeClass("active");
		$("#user-table").find("tbody tr:not(.user-details)").css({"opacity": "1"});
		$("#listof-apps").hide();
	}
	
	function addCancelTemplateClick(){
		if(_.size(new_temp_data) != 0){
			console.log("new_temp_data size = " + _.size(new_temp_data));
		}
		closeActiveEdit();
		//new_temp_bar = null;
	}

	function clearNewBarData()
	{
		console.log("clear new bar data");
		$("#filter_container").empty();
		new_temp_data = [];
		new_temp_bar = null;
		new_params = {};
		user_templates = {};
	}

	function addSaveTemplateClick(){
		$(".email-check.green-text").remove();
		$(".username-check.green-text").remove();
		var data = {};
		var user_name = $('#menu-username').text();

		console.log("get value : ");
		var values = {};
		$("div#create_temp_details *").each( function(i){
			console.log(jQuery(this).val());
			if($(this).hasClass("condition-text")){
				//console.log($(this).val());
			}
		})

		var input_text = new_temp_bar.find(".condition-text").val();
		console.log("input_text " + input_text);		

    	console.log("save template!");
	}

	function addnewbarClick(){
		   console.log("trigger addnewbarClick");
		   var __temp = {};	

		   if(($("#channel-params-category").text()=="") || 
			 ($("#mode-params-category").text() == "") ||
			 ($("#ssid-params-input").val()=="") )
		   {
   
		   	console.log("params empty");
		   	return;
		   }
   
		   if( new_temp_bar != null){
		    new_temp_bar.find("*").each(function(i){
		    	if($(this).hasClass("condition-text")){
		    		console.log($(this).val());
		    		__temp.input = $(this).val();
		    	}
		    	if( $(this).hasClass("text_condition") ){
		    		console.log($(this).data("value"));
		    		console.log($(this).text());
		    		__temp.condition_temp = $(this).text();
		    	}
		    	if( $(this).hasClass("text_judgement") ){
		    		console.log($(this).text());
		    		console.log($(this).data("value"));
		    		__temp.judgement = $(this).text();
		    	}		    	
		    })		   
		   }

		   if( (__temp.input =="") || (__temp.condition_temp == "") || (__temp.judgement == "") ){
		     	console.log("data empty" + __temp);
		     	return;
		   }else{
		   		 new_temp_data.push(__temp);
		   }   

		   new_temp_bar = $("#new-temp-bar>div").clone();
		   $(this).parent().parent().append(new_temp_bar);
		   $(new_temp_bar).find("*").each(function(i){
		    	if($(this).hasClass("select-temps-add")){
		    		console.log("register event!");
		    		$(this).bind("click",addnewbarClick);
		    	}    	   
		   });		   
		   initializeSelect();		   
	}

	$("#user-table").find("tbody tr").not(".user-details").on('click', function() {
		if (!lastUserSaved && previousUserDetails) {
			previousUserDetails.replaceWith(userDetailsClone);
			previousUserDetails = null;
		}

		clearNewBarData();
		if( new_temp_bar == null){
			new_temp_bar = $("#new-temp-bar>div").clone();
			$("#filter_container").append(new_temp_bar);	
		    new_temp_bar.find("*").each(function(i){
		    	if($(this).hasClass("select-temps-add")){
		    		console.log("register event!");
		    		$(this).bind("click",addnewbarClick);
		    	} 
		    	if($(this).hasClass("cancel-template")){
		    		console.log("register the cancel event");
		    		$(this).bind("click",addCancelTemplateClick);
		    	}
		    	if($(this).hasClass("save-template")){
		    		console.log("register the cancel event");
		    		$(this).bind("click",addSaveTemplateClick);
		    	}
		    });
		}

		lastUserSaved = false;
		userDetailsClone = $(this).next(".user-details").clone(true);	
		$("#listof-apps").hide();
		if ($(this).hasClass("active")) {
			closeActiveEdit();
		} else {
			$("#user-table tbody tr").removeClass("active");
			$(this).addClass("active");
			
			$(".user-details").hide();
			$(this).next(".user-details").toggle();
			previousUserDetails = $(this).next(".user-details");
			
			var currUserDetails = $(".user-details:visible");
			currUsername = currUserDetails.find(".username-text").val();
			currEmail = currUserDetails.find(".email-text").val();
		}
		initializeSelect();
	});
	
	
	$(".select-temps").on('click',function(){
		//$(this).parent().hide();
		//$(this).parent().prev().hide();
		//$(this).parent().prev().parent().remove();
		$(this).parent().parent().remove();
		console.log("click template select-temp !");
	});

/*
	$(".select-temps-add").on('click',function(){
		var __temp = {};		

		if( new_temp_bar != null){
		    new_temp_bar.find("*").each(function(i){
		    	if($(this).hasClass("condition-text")){
		    		console.log($(this).val());
		    		__temp.input = $(this).val();
		    	}
		    	if( $(this).hasClass("text_condition") ){
		    		console.log($(this).data("value"));
		    		console.log($(this).text());
		    		__temp.condition_temp = $(this).text();
		    	}
		    	if( $(this).hasClass("text_judgement") ){
		    		console.log($(this).text());
		    		console.log($(this).data("value"));
		    		__temp.judgement = $(this).text();
		    	}		    	
		    })
		}else{
		    $("#first_temps_bar").find("*").each(function(i){
		    	if($(this).hasClass("condition-text")){
		    		console.log($(this).val());
		    		__temp.input = $(this).val();
		    	}
		    	if( $(this).hasClass("text_condition") ){
		    		console.log($(this).data("value"));
		    		console.log($(this).text());
		    		__temp.condition_temp = $(this).text();
		    	}
		    	if( $(this).hasClass("text_judgement") ){
		    		console.log($(this).text());
		    		console.log($(this).data("value"));
		    		__temp.judgement = $(this).text();
		    	}		    	
		    })
		}	
		
		if ( ($("#channel-params-category").text()=="") || 
			 ($("#mode-params-category").text() == "") ||
			 ($("#ssid-params-input").val()=="") ){

			console.log("params empty");
			return;
		}

		if( (__temp.input =="") || (__temp.condition_temp == "") || (__temp.judgement == "") ){
		  	console.log("data empty" + __temp);
		  	return;
		}

		new_temp_data.push(__temp);
		new_temp_bar = $("#new-temp-bar>div").clone();
		$(this).parent().parent().append(new_temp_bar);
		initializeSelect();
		console.log("new_temp_data = " + new_temp_data);
	});

*/

	$(".select-apps").on('click', function() {
		$("#listof-apps .app").removeClass("selected");
		activeRow = $(this).parent(".row");
		var buttonPos = $(this).offset();
		buttonPos.top += 26;
		buttonPos.left -= 18;
		
		if ($("#listof-apps").is(":visible") && JSON.stringify(buttonPos) === JSON.stringify(previousSelectAppPos)) {
			$("#listof-apps").hide();
			return true;
		}
		
		previousSelectAppPos = buttonPos;
		
		var appList = activeRow.find(".app-list").val().split(","),
			adminAppList = $(".admin-apps:visible .app-list").val().split(","),
			isAdminApps = activeRow.hasClass("admin-apps");
		
		$("#listof-apps").find(".app_id").each(function() {
			if (appList.indexOf($(this).val()) != -1) {
				$(this).parent().addClass("selected");
			}
			
			if (!isAdminApps && adminAppList.indexOf($(this).val()) != -1) {
				$(this).parent().addClass("disabled");
			} else {
				$(this).parent().removeClass("disabled");
			}
		});
		
		if ($("#listof-apps .app:not(.disabled)").length == 0) {
			$("#select-all").hide();
			$("#deselect-all").hide();
		} else if ($("#listof-apps .app.selected").length == $("#listof-apps .app").length) {
			$("#select-all").hide();
			$("#deselect-all").show();
		} else {
			$("#select-all").show();
			$("#deselect-all").hide();
		}
		
		$("#listof-apps").show().offset(buttonPos);
	});
	
	$(".create-user").on("click", function() {		
		$("#listof-apps").hide();
		$(".email-check.green-text").remove();
		$(".username-check.green-text").remove();
		
		var data = {},
			currUserDetails = $(".user-details:visible");
		
		data.full_name = currUserDetails.find(".full-name-text").val();
		data.username = currUserDetails.find(".username-text").val();
		data.email = currUserDetails.find(".email-text").val();
		data.global_admin = currUserDetails.find(".global-admin").hasClass("checked");
		data.password = currUserDetails.find(".password-text").val();
		
		$(".required").fadeOut().remove();
		var reqSpan = $("<span>").addClass("required").text("*");
		
		if (!data.password.length) {
			currUserDetails.find(".password-text").after(reqSpan.clone());
		}
		
		if (!data.full_name.length) {
			currUserDetails.find(".full-name-text").after(reqSpan.clone());
		}
		
		if (!data.username.length) {
			currUserDetails.find(".username-text").after(reqSpan.clone());
		}
		
		if (!data.email.length) {
			currUserDetails.find(".email-text").after(reqSpan.clone());
		} else if (!validateEmail(data.email)) {
			$(".email-check").remove();
			var invalidSpan = $("<span class='email-check red-text'>").html(jQuery.i18n.map["management-users.email.invalid"]);
			currUserDetails.find(".email-text").after(invalidSpan.clone());
		}
		
		if ($(".required").length) {
			$(".required").fadeIn();
			return false;
		} else if ($(".red-text").length) {
			return false;
		}
		
		if (!data.global_admin) {
			data.admin_of = currUserDetails.find(".admin-apps .app-list").val().split(",");
			data.user_of = currUserDetails.find(".user-apps .app-list").val().split(",");
		}

		$.ajax({
			type: "GET",
            url: countlyCommon.API_PARTS.users.w + '/create',
            data: {
                args: JSON.stringify(data),
                api_key: countlyGlobal['member'].api_key
            },
            dataType: "jsonp",
			success: function() {
				app.activeView.render();
			}
		});
	});
	
	$(".save-user").on("click", function() {
		$("#listof-apps").hide();
		$(".email-check.green-text").remove();
		$(".username-check.green-text").remove();
		
		lastUserSaved = true;
		
		var data = {},
			currUserDetails = $(".user-details:visible"),
			changedPassword = false;
		
		data.user_id = $(this).parent(".button-container").find(".user_id").val();
		data.full_name = currUserDetails.find(".full-name-text").val();
		data.username = currUserDetails.find(".username-text").val();
		data.email = currUserDetails.find(".email-text").val();
		
		$(".required").fadeOut().remove();
		var reqSpan = $("<span>").addClass("required").text("*");
		
		if (!data.full_name.length) {
			currUserDetails.find(".full-name-text").after(reqSpan.clone());
		}
		
		if (!data.username.length) {
			currUserDetails.find(".username-text").after(reqSpan.clone());
		}
		
		if (!data.email.length) {
			currUserDetails.find(".email-text").after(reqSpan.clone());
		}
		
		if ($(".required").length) {
			$(".required").fadeIn();
			return false;
		} else if ($(".red-text").length) {
			return false;
		}
		
		if (currUserDetails.find(".delete-user").length != 0) {
			data.global_admin = currUserDetails.find(".global-admin").hasClass("checked");
			
			if (!data.global_admin) {
				data.admin_of = currUserDetails.find(".admin-apps .app-list").val().split(",");
				data.user_of = currUserDetails.find(".user-apps .app-list").val().split(",");
			}
		}
		
		if (currUserDetails.find(".password-row").is(":visible") && currUserDetails.find(".password-text").val().length) {
			data.password = currUserDetails.find(".password-text").val();
			changedPassword = true;
		}
		
		if (changedPassword) {
			CountlyHelpers.confirm(jQuery.i18n.prop('management-users.password-change-confirm', data.full_name), "black", function(result) {
				if (result) {
					data.send_notification = true;
				}
				
				saveUser();
			}, [jQuery.i18n.map["common.no"], jQuery.i18n.map["common.yes"]]);
		} else {
			saveUser();
		}
		
		function saveUser() {
			$.ajax({
				type: "GET",
                url: countlyCommon.API_PARTS.users.w + '/update',
                data: {
                    args: JSON.stringify(data),
                    api_key: countlyGlobal['member'].api_key
                },
                dataType: "jsonp",
				success: function(result) {
					if (currUserDetails.find(".delete-user").length == 0) {
						$("#menu-username").text(data.username);
					}
					app.activeView.render();
				}
			});
		}
	});
	
	$(".username-text").keyup(_.throttle(function() {
		if (!($(this).val().length) || currUsername == $(this).val()) {
			$(".username-check").remove();
			return false;
		}
	
		$(this).next(".required").remove();
	
		var existSpan = $("<span class='username-check red-text'>").html(jQuery.i18n.map["management-users.username.exists"]),
			notExistSpan = $("<span class='username-check green-text'>").html("&#10004;"),
			data = {};
		
		data.username = $(this).val();
		data._csrf = countlyGlobal['csrf_token'];
	
		var self = $(this);
		$.ajax({
			type: "POST",
			url: "/users/check/username",
			data: data,
			success: function(result) {
				$(".username-check").remove();
				if (result) {
					self.after(notExistSpan.clone());
				} else {
					self.after(existSpan.clone());
				}
			}
		});
	}, 300));
	
	$(".email-text").keyup(_.throttle(function() {
		if (!($(this).val().length) || currEmail == $(this).val()) {
			$(".email-check").remove();
			return false;
		}
		
		$(this).next(".required").remove();
		
		if (!validateEmail($(this).val())) {
			$(".email-check").remove();
			var invalidSpan = $("<span class='email-check red-text'>").html(jQuery.i18n.map["management-users.email.invalid"]);
			$(this).after(invalidSpan.clone());
			return false;
		}
		
		var existSpan = $("<span class='email-check red-text'>").html(jQuery.i18n.map["management-users.email.exists"]),
			notExistSpan = $("<span class='email-check green-text'>").html("&#10004;"),
			data = {};
		
		data.email = $(this).val();
		data._csrf = countlyGlobal['csrf_token'];
		
		var self = $(this);
		$.ajax({
			type: "POST",
			url: "/users/check/email",
			data: data,
			success: function(result) {
				$(".email-check").remove();
				if (result) {
					self.after(notExistSpan.clone());
				} else {
					self.after(existSpan.clone());
				}
			}
		});
	}, 300));

    $(".save-template").on("click",function() {
		$(".email-check.green-text").remove();
		$(".username-check.green-text").remove();
		var data = {};
		var __temp = {};
		var user_name = $('#menu-username').text();
		var data_ok = 1;
		var input_text , condition_text, judgement_text,wifimode_text,channel_text,ssid_text;

		$(".required").fadeOut().remove();
		var reqSpan = $("<span>").addClass("required").text("*");
		if ( ($("#channel-params-category").text()=="") || 
			($("#mode-params-category").text() == "") ||
			($("#ssid-params-input").val()=="") )
		{   	 		
			wifimode_text = $("#mode-params-category").data("value");
			channel_text = $("#channel-params-category").data("value");
			ssid_text = $("#ssid-params-input").val();

			if(!ssid_text){
				 $("#ssid-params-input").after(reqSpan.clone());
			}

			if(!channel_text){
				$("#channel-params-category").parents(".cly-select").after(reqSpan.clone());
			}

			if(!wifimode_text){
				$("#mode-params-category").parents(".cly-select").after(reqSpan.clone());
            }

		 	data_ok = 0;
		 }

		 var input_empty;
		if( new_temp_bar != null){
		 new_temp_bar.find("*").each(function(i){
		 	if($(this).hasClass("condition-text")){
		 		console.log($(this).val());
		 		__temp.input = $(this).val();
		 		input_text = $(this).val();
		 		input_empty = $(this);
		 	}
		 	if( $(this).hasClass("text_condition") ){
		 		console.log($(this).data("value"));
		 		console.log($(this).text());
		 		__temp.condition_temp = $(this).text();
		 		condition_text = $(this).data("value");
		 	}
		 	if( $(this).hasClass("text_judgement") ){
		 		console.log($(this).text());
		 		console.log($(this).data("value"));
		 		__temp.judgement = $(this).text();
		 		judgement_text = $(this).data("value");
		 	}		    	
		 })
		}

		if( (__temp.input =="") || (__temp.condition_temp == "") || (__temp.judgement == "") ){	  	
		  	data_ok = 0;
		  	input_empty.after(reqSpan.clone());
		}
        if ($(".required").length) {
            $(".required").fadeIn();
            return false;
        }


		if (data_ok) {
	    	new_params.wifimode = $("#mode-params-category").text();
	    	new_params.channel = $("#channel-params-category").text();
	    	new_params.ssid = $("#ssid-params-input").val();		    			
			new_temp_data.push(__temp);

		    user_templates.user = user_name;
		    user_templates.templates = new_temp_data;
		    user_templates.params = new_params;
   
		    countlyDevmgr.createTemplateByUser(user_templates);
		    //clearNewBarData();
		    //closeActiveEdit();	
			//saveUser();
			app.activeView.render();
		} else {			
			return;
		}


		function saveUser() {
			$.ajax({
				type: "GET",
                url: countlyCommon.API_PARTS.users.w + '/update',
                data: {
                    args: JSON.stringify(data),
                    api_key: countlyGlobal['member'].api_key
                },
                dataType: "jsonp",
				success: function(result) {
					if (currUserDetails.find(".delete-user").length == 0) {
						$("#menu-username").text(data.username);
					}
					app.activeView.render();
				}
			});
		}			 

    });

	$(".cancel-user").on("click", function() {
		closeActiveEdit();
	});

	$(".cancel-template").on("click", function() {
		//console.log("new_temp_data after = " + new_temp_data);
		clearNewBarData();
		closeActiveEdit();
	});	

	$(".delete-user").on("click", function() {
		var currUserDetails = $(".user-details:visible");
		var fullName = currUserDetails.find(".full-name-text").val();
	
		var self = $(this);
		CountlyHelpers.confirm(jQuery.i18n.prop('management-users.delete-confirm', fullName), "red", function(result) {
			
			if (!result) {
				return false;
			}
		
			var data = {
                user_ids: [self.parent(".button-container").find(".user_id").val()]
            };

			$.ajax({
				type: "GET",
                url: countlyCommon.API_PARTS.users.w + '/delete',
                data: {
                    args: JSON.stringify(data),
                    api_key: countlyGlobal['member'].api_key
                },
                dataType: "jsonp",
				success: function(result) {
					currUserDetails.hide();
					currUserDetails.prev("tr").remove();
					currUserDetails.remove();
				}
			});
		});
	});
	
	$('.scrollable').slimScroll({
		height: '100%',
		start: 'top',
		wheelStep: 10,
		position: 'right'
	});

	$("#select-all").on('click', function() {
		$("#listof-apps .app:not(.disabled)").addClass("selected");
		adminsOf = [];
		var adminOfIds = [];
		
		$("#listof-apps .app.selected").each(function() {
			adminsOf[adminsOf.length] = $(this).find(".name").text();
			adminOfIds[adminOfIds.length] = $(this).find(".app_id").val();
		});
		
		activeRow.find(".user-admin-list").text(adminsOf.join(", "));
		activeRow.find(".app-list").val(adminOfIds.join(","));
		activeRow.find(".no-apps").hide();
		
		var userAppRow = activeRow.next(".user-apps");
		
		if (userAppRow.length) {
			userAppRow.find(".user-admin-list").text(adminsOf.join(", "));
			userAppRow.find(".app-list").val(adminOfIds.join(","));
			userAppRow.find(".no-apps").hide();
		}
		
		$(this).hide();
		$("#deselect-all").show();
	});
	
	$("#deselect-all").on('click', function() {
		$("#listof-apps").find(".app:not(.disabled)").removeClass("selected");
		
		adminsOf = [];
		var adminOfIds = [];
		
		$("#listof-apps .app.selected").each(function() {
			adminsOf[adminsOf.length] = $(this).find(".name").text();
			adminOfIds[adminOfIds.length] = $(this).find(".app_id").val();
		});
		
		activeRow.find(".user-admin-list").text(adminsOf.join(", "));
		activeRow.find(".app-list").val(adminOfIds.join(","));
		
		if ($("#listof-apps .app.selected").length == 0) {
			activeRow.find(".no-apps").show();
		} else {
			activeRow.find(".no-apps").hide();
		}
		
		$(this).hide();
		$("#select-all").show();
	});
			
	$("#listof-apps .app").on('click', function() {
		
		if ($(this).hasClass("disabled")) {
			return true;
		}
		
		$(this).toggleClass("selected");
		
		if ($("#listof-apps .app.selected").length == $("#listof-apps .app").length) {
			$("#select-all").hide();
			$("#deselect-all").show();
		} else {
			$("#select-all").show();
			$("#deselect-all").hide();
		}
		
		adminsOf = [];
		var adminOfIds = [];
		$("#listof-apps .app.selected").each(function() {
			adminsOf[adminsOf.length] = $(this).find(".name").text();
			adminOfIds[adminOfIds.length] = $(this).find(".app_id").val();
		});
		
		if ($("#listof-apps .app.selected").length == 0) {
			activeRow.find(".no-apps").show();
		} else {
			activeRow.find(".no-apps").hide();
		}
		
		activeRow.find(".user-admin-list").text(adminsOf.join(", "));
		activeRow.find(".app-list").val(adminOfIds.join(","));
		
		var userAppRow = activeRow.next(".user-apps");
		
		if (userAppRow.length) {
			var userAppIds = userAppRow.find(".app-list").val(),
				usersOfIds = (userAppIds)? userAppIds.split(",") : [];
		
			for (var i = 0; i < adminOfIds.length; i++) {
				if (usersOfIds.indexOf(adminOfIds[i]) == -1) {
					if (usersOfIds.length == 0 && i == 0) {
						userAppRow.find(".user-admin-list").text(adminsOf[i]);
						userAppRow.find(".app-list").val(adminOfIds[i]);
					} else {
						userAppRow.find(".user-admin-list").text(userAppRow.find(".user-admin-list").text().trim() + ", " + adminsOf[i]);
						userAppRow.find(".app-list").val(userAppRow.find(".app-list").val() + "," + adminOfIds[i]);
					}
					
					userAppRow.find(".no-apps").hide();
				}
			}
		}
	});
	
	$("#done").on('click', function() {
		$("#listof-apps").hide();
	});	

	$(".global-admin").on('click', function() {
		var currUserDetails = $(".user-details:visible");
		
		currUserDetails.find(".user-apps").toggle();
		currUserDetails.find(".admin-apps").toggle();	
		$(this).toggleClass("checked");
		$("#listof-apps").hide();
	});

	$(".generate-password").on('click', function() {
		$(this).parent().find(".password-text").val(generatePassword());
	});
	
	$(".change-password").on('click', function() {
		$(this).parents(".row").next().toggle();
	});

	initializeSelect();
});
</script>

